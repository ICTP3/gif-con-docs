name: Discord Notify

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Discordã¸é€šçŸ¥ã‚’é€ä¿¡
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MESSAGE=$(jq -r '.head_commit.message' $GITHUB_EVENT_PATH)
          COMMIT_AUTHOR=$(jq -r '.head_commit.author.name' $GITHUB_EVENT_PATH)
          REPO_NAME=$(jq -r '.repository.name' $GITHUB_EVENT_PATH)
          COMMIT_URL=$(jq -r '.head_commit.url' $GITHUB_EVENT_PATH)
          BRANCH=$(jq -r '.ref' $GITHUB_EVENT_PATH | sed 's/refs\/heads\///')

          payload=$(jq -n \
            --arg repo "$REPO_NAME" \
            --arg author "$COMMIT_AUTHOR" \
            --arg message "$COMMIT_MESSAGE" \
            --arg url "$COMMIT_URL" \
            --arg branch "$BRANCH" \
            '{
              "username": "ğŸ£ Gif-Con CI Bot",
              "embeds": [{
                "title": "ğŸš€ æ–°ã—ã„ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸï¼",
                "description": ("ğŸ§¾ **ãƒªãƒã‚¸ãƒˆãƒª:** \($repo)\nğŸŒ¿ **ãƒ–ãƒ©ãƒ³ãƒ:** \($branch)\nğŸ‘¤ **ã‚³ãƒŸãƒƒã‚¿ãƒ¼:** \($author)\nğŸ’¬ **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:** \n```" + $message + "```\nğŸ”— [ã‚³ãƒŸãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹](" + $url + ")"),
                "color": 16761035,
                "footer": {
                  "text": "Gif-Con é–‹ç™ºãƒãƒ¼ãƒ  | è‡ªå‹•é€šçŸ¥"
                },
                "timestamp": (now | todate)
              }]
            }')

          curl -H "Content-Type: application/json" \
               -d "$payload" \
               "$WEBHOOK_URL"

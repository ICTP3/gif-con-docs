name: Discord Notify (Gif-Con Team JP)

on:
  push:
    branches:
      - main
      - feature/**
      - fix/**
      - docs/**

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Discordã¸é€šçŸ¥ã‚’é€ä¿¡
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # ===== GitHubæƒ…å ±ã®å–å¾— =====
          COMMIT_MESSAGE=$(jq -r '.head_commit.message' $GITHUB_EVENT_PATH)
          COMMIT_AUTHOR=$(jq -r '.head_commit.author.name' $GITHUB_EVENT_PATH)
          REPO_NAME=$(jq -r '.repository.name' $GITHUB_EVENT_PATH)
          COMMIT_URL=$(jq -r '.head_commit.url' $GITHUB_EVENT_PATH)
          BRANCH=$(jq -r '.ref' $GITHUB_EVENT_PATH | sed 's/refs\/heads\///')

          # ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‰²ã‚’ãƒ–ãƒ©ãƒ³ãƒã§å¤‰æ›´ =====
          COLOR=5793266 # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šé’ç·‘
          if [[ "$BRANCH" == feature/* ]]; then
            COLOR=16776960  # é»„è‰²ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
          elif [[ "$BRANCH" == fix/* ]]; then
            COLOR=16733525  # èµ¤ï¼ˆä¿®æ­£ï¼‰
          elif [[ "$BRANCH" == docs/* ]]; then
            COLOR=10070709  # ã‚°ãƒ¬ãƒ¼ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰
          fi

          # ===== DiscordåŸ‹ã‚è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ =====
          payload=$(jq -n \
            --arg repo "$REPO_NAME" \
            --arg author "$COMMIT_AUTHOR" \
            --arg message "$COMMIT_MESSAGE" \
            --arg url "$COMMIT_URL" \
            --arg branch "$BRANCH" \
            --argjson color "$COLOR" \
            '{
              "username": "ğŸ£ Gif-Con CI Bot",
              "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "embeds": [{
                "title": "ğŸš€ æ–°ã—ã„ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸï¼",
                "description":
                  "**â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**\n"
                  + "ğŸ§¾ **ãƒªãƒã‚¸ãƒˆãƒª:** \($repo)\n"
                  + "ğŸŒ¿ **ãƒ–ãƒ©ãƒ³ãƒ:** \($branch)\n"
                  + "ğŸ‘¤ **ã‚³ãƒŸãƒƒã‚¿ãƒ¼:** \($author)\n"
                  + "**â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”**\n"
                  + "ğŸ’¬ **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:**\n```" + $message + "```\n"
                  + "ğŸ”— [ã‚³ãƒŸãƒƒãƒˆã‚’ç¢ºèªã™ã‚‹](" + $url + ")",
                "color": $color,
                "footer": {
                  "text": "Gif-Con é–‹ç™ºãƒãƒ¼ãƒ  | è‡ªå‹•é€šçŸ¥"
                },
                "timestamp": (now | todate)
              }]
            }')

          # ===== Discordã¸é€ä¿¡ =====
          curl -H "Content-Type: application/json" \
               -d "$payload" \
               "$WEBHOOK_URL"
